import React, { useState, useEffect } from 'react';
import { FestivalType, ThemeConfig, ChecklistItem, Expense } from '../types';
import { FESTIVAL_DATES } from '../constants';
import { 
  LayoutDashboard, CheckSquare, Wallet, Leaf, Store, Image, 
  Clock, CloudSun, AlertTriangle, ChevronRight, Plus, User, 
  MapPin, Share2, Camera, Calendar, Trash2
} from 'lucide-react';

interface HubProps {
  theme: ThemeConfig;
  selectedFestival: FestivalType;
  checklist: ChecklistItem[];
  budget: number;
  familySize: number;
  onToggleItem: (id: string) => void;
  onAddExpense: (amount: number, category: string) => void;
}

type View = 'Home' | 'Checklist' | 'Budget' | 'Eco' | 'Market' | 'Memories';

const Hub: React.FC<HubProps> = ({ theme, selectedFestival, checklist, budget, familySize, onToggleItem }) => {
  const [activeView, setActiveView] = useState<View>('Home');
  const [timeLeft, setTimeLeft] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [newExpenseAmount, setNewExpenseAmount] = useState('');
  const [newExpenseCategory, setNewExpenseCategory] = useState('Food');

  // Countdown Logic
  useEffect(() => {
    const targetDate = new Date(FESTIVAL_DATES[selectedFestival] || new Date().getFullYear() + '-12-31');
    // If target date is past, add a year (mock logic for demo)
    if (targetDate.getTime() < Date.now()) {
        targetDate.setFullYear(targetDate.getFullYear() + 1);
    }

    const timer = setInterval(() => {
      const now = new Date();
      const difference = targetDate.getTime() - now.getTime();
      
      if (difference > 0) {
        setTimeLeft({
          days: Math.floor(difference / (1000 * 60 * 60 * 24)),
          hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
          minutes: Math.floor((difference / 1000 / 60) % 60),
          seconds: Math.floor((difference / 1000) % 60),
        });
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [selectedFestival]);

  // Derived Stats
  const completedTasks = checklist.filter(i => i.isCompleted).length;
  const progress = Math.round((completedTasks / checklist.length) * 100) || 0;
  const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
  const budgetRemaining = budget - totalSpent;
  const ecoPoints = checklist.filter(i => i.isCompleted && i.ecoTip).length * 10;
  
  const handleAddExpense = (e: React.FormEvent) => {
      e.preventDefault();
      if (!newExpenseAmount) return;
      const newExp: Expense = {
          id: Date.now().toString(),
          category: newExpenseCategory,
          amount: parseFloat(newExpenseAmount),
          note: 'Manual Entry'
      };
      setExpenses([newExp, ...expenses]);
      setNewExpenseAmount('');
  };

  const NavButton = ({ view, icon: Icon, label }: { view: View; icon: any; label: string }) => (
    <button
      onClick={() => setActiveView(view)}
      className={`
        flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300
        ${activeView === view 
          ? `${theme.colors.accent} ${selectedFestival === 'Holi' ? 'text-white' : 'text-slate-900'} shadow-lg scale-110` 
          : `${theme.colors.textMuted} hover:bg-white/10`}
      `}
    >
      <Icon className="w-6 h-6 mb-1" />
      <span className="text-[10px] uppercase font-bold tracking-wider">{label}</span>
    </button>
  );

  return (
    <div className="flex flex-col h-screen max-w-7xl mx-auto md:flex-row overflow-hidden rounded-none md:rounded-3xl shadow-2xl backdrop-blur-xl bg-black/40 border border-white/10">
      
      {/* Sidebar (Desktop) / Bottom Nav (Mobile) */}
      <div className={`
        md:w-24 md:h-full w-full h-20 
        ${theme.colors.cardBg} border-r border-white/10
        flex md:flex-col flex-row items-center justify-around md:justify-center md:gap-8
        fixed md:relative bottom-0 z-50 md:z-auto backdrop-blur-xl
      `}>
        <NavButton view="Home" icon={LayoutDashboard} label="Home" />
        <NavButton view="Checklist" icon={CheckSquare} label="Tasks" />
        <NavButton view="Budget" icon={Wallet} label="Budget" />
        <NavButton view="Eco" icon={Leaf} label="Eco" />
        <NavButton view="Market" icon={Store} label="Market" />
        <NavButton view="Memories" icon={Image} label="Mems" />
      </div>

      {/* Main Content Area */}
      <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8 relative scroll-smooth">
        
        {/* Header */}
        <div className="flex justify-between items-center mb-8">
            <div>
                <h2 className={`text-3xl font-serif font-bold ${theme.colors.textMain}`}>{activeView}</h2>
                <p className={`text-sm ${theme.colors.textMuted}`}>Preparing for {selectedFestival}</p>
            </div>
            <div className={`px-4 py-2 rounded-full border ${theme.colors.border} ${theme.colors.textMain} bg-black/20 flex items-center gap-2`}>
                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span className="text-xs font-mono">ONLINE</span>
            </div>
        </div>

        {/* --- VIEW: HOME --- */}
        {activeView === 'Home' && (
            <div className="space-y-6 animate-in slide-in-from-right duration-500">
                {/* Countdown Card */}
                <div className={`p-6 rounded-3xl bg-gradient-to-r ${theme.colors.background} border ${theme.colors.border} relative overflow-hidden group`}>
                     <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform duration-700">
                         <Clock className="w-32 h-32 text-white" />
                     </div>
                     <h3 className={`text-sm font-bold uppercase tracking-widest ${theme.colors.textMuted} mb-4`}>Time Until Celebration</h3>
                     <div className="flex gap-4 md:gap-8 text-center relative z-10">
                         {['days', 'hours', 'minutes', 'seconds'].map((unit) => (
                             <div key={unit} className="flex flex-col">
                                 <span className={`text-3xl md:text-5xl font-mono font-bold ${theme.colors.textMain}`}>
                                     {/* @ts-ignore */ timeLeft[unit].toString().padStart(2, '0')}
                                 </span>
                                 <span className={`text-xs uppercase ${theme.colors.textMuted}`}>{unit}</span>
                             </div>
                         ))}
                     </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Urgency Meter */}
                    <div className={`${theme.colors.cardBg} p-6 rounded-3xl border ${theme.colors.border}`}>
                        <div className="flex items-center gap-3 mb-4">
                            <AlertTriangle className={`w-5 h-5 ${timeLeft.days < 7 ? 'text-red-500' : 'text-yellow-500'}`} />
                            <h3 className={`text-lg font-bold ${theme.colors.textMain}`}>Shopping Urgency</h3>
                        </div>
                        <div className="relative pt-4 pb-2">
                             <div className="flex justify-between text-xs mb-2 text-gray-400">
                                 <span>Chill Mode</span>
                                 <span>Panic Mode</span>
                             </div>
                             <div className="h-4 bg-gray-700 rounded-full overflow-hidden">
                                 <div 
                                     className={`h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 transition-all duration-1000`}
                                     style={{ width: `${Math.max(10, 100 - (timeLeft.days * 2))}%` }}
                                 />
                             </div>
                             <p className={`mt-4 text-sm ${theme.colors.textMuted}`}>
                                 {timeLeft.days > 14 ? "You have plenty of time. Relax!" : "Ideally, finish shopping by this weekend!"}
                             </p>
                        </div>
                    </div>

                    {/* Weather Widget */}
                    <div className={`${theme.colors.cardBg} p-6 rounded-3xl border ${theme.colors.border}`}>
                        <div className="flex items-center justify-between mb-4">
                             <div className="flex items-center gap-3">
                                <CloudSun className={`w-5 h-5 ${theme.colors.primary}`} />
                                <h3 className={`text-lg font-bold ${theme.colors.textMain}`}>Festival Forecast</h3>
                             </div>
                             <span className="text-xs bg-white/10 px-2 py-1 rounded text-white">New Delhi</span>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className={`text-4xl font-bold ${theme.colors.textMain}`}>28°C</div>
                            <div className={`text-sm ${theme.colors.textMuted}`}>
                                Clear skies expected.<br/>Perfect for outdoor rituals.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* --- VIEW: CHECKLIST --- */}
        {activeView === 'Checklist' && (
            <div className="space-y-4 animate-in slide-in-from-bottom duration-500">
                {checklist.map(item => (
                    <div 
                        key={item.id}
                        onClick={() => onToggleItem(item.id)}
                        className={`
                            group flex items-center p-4 rounded-2xl border transition-all duration-300 cursor-pointer
                            ${item.isCompleted ? 'bg-black/20 border-transparent opacity-50' : `${theme.colors.cardBg} ${theme.colors.border} hover:scale-[1.01]`}
                        `}
                    >
                        <div className={`w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center transition-colors ${item.isCompleted ? `${theme.colors.accent} border-transparent` : theme.colors.textMuted}`}>
                            {item.isCompleted && <span className="text-white text-xs">✓</span>}
                        </div>
                        <div className="flex-1">
                            <h4 className={`text-lg font-medium ${theme.colors.textMain} ${item.isCompleted && 'line-through'}`}>{item.task}</h4>
                            <div className="flex items-center gap-3 mt-1">
                                <span className={`text-xs px-2 py-0.5 rounded bg-white/10 ${theme.colors.textMuted}`}>{item.category}</span>
                                <span className="text-xs text-gray-500 flex items-center gap-1">
                                    <User className="w-3 h-3" /> {item.assignee || 'Family'}
                                </span>
                            </div>
                        </div>
                        <div className={`text-sm font-mono ${theme.colors.secondary}`}>₹{item.estimatedCost}</div>
                    </div>
                ))}
            </div>
        )}

        {/* --- VIEW: BUDGET --- */}
        {activeView === 'Budget' && (
            <div className="space-y-6 animate-in zoom-in duration-500">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Visual Chart */}
                    <div className={`${theme.colors.cardBg} p-6 rounded-3xl border ${theme.colors.border} flex flex-col items-center justify-center`}>
                        <div 
                            className="w-48 h-48 rounded-full border-8 border-gray-800 relative flex items-center justify-center mb-4"
                            style={{
                                background: `conic-gradient(${theme.colors.accent.replace('bg-', 'var(--tw-color-)')} ${(totalSpent/budget)*360}deg, transparent 0)`
                            }}
                        >
                            <div className="absolute inset-2 bg-gray-900 rounded-full flex flex-col items-center justify-center">
                                <span className={`text-sm ${theme.colors.textMuted}`}>Spent</span>
                                <span className={`text-2xl font-bold ${theme.colors.textMain}`}>₹{totalSpent}</span>
                            </div>
                        </div>
                        <div className={`text-center ${theme.colors.textMuted} text-sm`}>
                            Budget Remaining: <span className="text-white font-bold">₹{budgetRemaining}</span>
                        </div>
                    </div>

                    {/* Add Expense */}
                    <div className={`${theme.colors.cardBg} p-6 rounded-3xl border ${theme.colors.border}`}>
                        <h3 className={`text-lg font-bold ${theme.colors.textMain} mb-4`}>Add Expense</h3>
                        <form onSubmit={handleAddExpense} className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400">Amount</label>
                                <input 
                                    type="number" 
                                    value={newExpenseAmount}
                                    onChange={e => setNewExpenseAmount(e.target.value)}
                                    className="w-full bg-black/20 border border-gray-700 rounded-xl p-3 text-white focus:outline-none focus:border-white/50"
                                    placeholder="0.00"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Category</label>
                                <select 
                                    value={newExpenseCategory}
                                    onChange={e => setNewExpenseCategory(e.target.value)}
                                    className="w-full bg-black/20 border border-gray-700 rounded-xl p-3 text-white focus:outline-none"
                                >
                                    {['Food', 'Decor', 'Gifts', 'Rituals', 'Travel', 'Other'].map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <button className={`w-full py-3 rounded-xl font-bold ${theme.colors.accent} ${selectedFestival === 'Holi' ? 'text-white' : 'text-black'}`}>
                                Add Record
                            </button>
                        </form>
                    </div>
                </div>

                {/* Expense List */}
                <div className={`${theme.colors.cardBg} rounded-3xl border ${theme.colors.border} overflow-hidden`}>
                    {expenses.length === 0 ? (
                        <div className="p-8 text-center text-gray-500">No expenses recorded yet.</div>
                    ) : (
                        expenses.map((exp, i) => (
                            <div key={exp.id} className={`flex justify-between items-center p-4 border-b border-white/5 last:border-0`}>
                                <div>
                                    <div className="text-white font-medium">{exp.category}</div>
                                    <div className="text-xs text-gray-500">{exp.note}</div>
                                </div>
                                <div className="text-white font-mono">-₹{exp.amount}</div>
                            </div>
                        ))
                    )}
                </div>
            </div>
        )}

        {/* --- VIEW: ECO HUB --- */}
        {activeView === 'Eco' && (
            <div className="space-y-6 animate-in slide-in-from-right duration-500">
                <div className="bg-green-900/20 border border-green-500/30 p-6 rounded-3xl relative overflow-hidden">
                    <Leaf className="absolute -right-4 -top-4 w-32 h-32 text-green-500/10 rotate-12" />
                    <h3 className="text-2xl font-bold text-green-400 mb-2">Eco-Warrior Status</h3>
                    <div className="flex items-end gap-2">
                        <span className="text-5xl font-bold text-white">{ecoPoints}</span>
                        <span className="text-green-300 mb-2">Green Points Earned</span>
                    </div>
                    <div className="mt-4 flex gap-2">
                        {[1,2,3].map(i => (
                            <div key={i} className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${ecoPoints >= i*50 ? 'border-green-400 bg-green-500/20 text-green-400' : 'border-gray-700 bg-gray-800/50 text-gray-600'}`}>
                                <Leaf className="w-6 h-6" />
                            </div>
                        ))}
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {checklist.filter(i => i.ecoTip).map(item => (
                        <div key={item.id} className={`${theme.colors.cardBg} p-4 rounded-2xl border ${theme.colors.border}`}>
                            <div className="text-sm text-gray-400 mb-1">Task: {item.task}</div>
                            <div className="text-green-300 font-medium flex gap-2 items-start">
                                <Leaf className="w-4 h-4 mt-1 shrink-0" />
                                {item.ecoTip}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* --- VIEW: MARKET --- */}
        {activeView === 'Market' && (
            <div className="animate-in fade-in duration-500">
                <div className={`${theme.colors.cardBg} p-6 rounded-3xl border ${theme.colors.border} text-center space-y-6`}>
                    <MapPin className={`w-16 h-16 mx-auto ${theme.colors.primary}`} />
                    <h3 className={`text-2xl font-bold ${theme.colors.textMain}`}>Local Vendor Guide</h3>
                    <p className={`${theme.colors.textMuted}`}>
                        We've located 12 top-rated stores near you for {selectedFestival} essentials.
                    </p>
                    
                    <div className="space-y-3 text-left">
                        {[1, 2, 3].map(i => (
                            <div key={i} className="bg-black/20 p-4 rounded-xl flex items-center gap-4 hover:bg-black/30 cursor-pointer transition-colors">
                                <div className={`w-12 h-12 rounded-lg ${theme.colors.accent} flex items-center justify-center text-black font-bold`}>
                                    {i}
                                </div>
                                <div className="flex-1">
                                    <h4 className={`font-bold ${theme.colors.textMain}`}>Sharma {selectedFestival} Store</h4>
                                    <p className="text-xs text-gray-400">0.8 km • 4.8 ⭐</p>
                                </div>
                                <ChevronRight className="text-gray-500" />
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        )}

        {/* --- VIEW: MEMORIES --- */}
        {activeView === 'Memories' && (
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 animate-in zoom-in duration-500">
                <div className={`aspect-square rounded-2xl border-2 border-dashed ${theme.colors.border} flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 transition-colors text-gray-400`}>
                    <Camera className="w-8 h-8 mb-2" />
                    <span className="text-xs">Add Photo</span>
                </div>
                {[1, 2, 3, 4].map(i => (
                    <div key={i} className="aspect-square rounded-2xl bg-gray-800 relative overflow-hidden group">
                        <img 
                            src={`https://picsum.photos/seed/${selectedFestival}${i}/400`} 
                            alt="Memory" 
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 opacity-80 group-hover:opacity-100" 
                        />
                         <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-4">
                             <span className="text-white text-xs">Day {i} Prep</span>
                         </div>
                    </div>
                ))}
            </div>
        )}

      </div>
    </div>
  );
};

export default Hub;
