import { GoogleGenAI, Type } from "@google/genai";
import { ChecklistItem, FestivalType } from "../types";

const generateFallbackPlan = (festival: FestivalType, budget: number): ChecklistItem[] => {
  const baseItems: ChecklistItem[] = [
    { id: '1', category: 'Cleaning', task: 'Deep clean living room', estimatedCost: 0, isCompleted: false, ecoTip: 'Use vinegar/lemon.', assignee: 'Dad' },
    { id: '2', category: 'Rituals', task: 'Prepare puja thali', estimatedCost: budget * 0.1, isCompleted: false, ecoTip: 'Reuse metal thalis.', assignee: 'Mom' },
    { id: '3', category: 'Food', task: 'Buy sweet ingredients', estimatedCost: budget * 0.3, isCompleted: false, ecoTip: 'Buy organic.', assignee: 'Grandma' },
    { id: '4', category: 'Decor', task: 'Put up lights', estimatedCost: budget * 0.2, isCompleted: false, ecoTip: 'Use LED lights.', assignee: 'Kids' },
    { id: '5', category: 'Gifts', task: 'Wrap gifts', estimatedCost: budget * 0.3, isCompleted: false, ecoTip: 'Use newspaper.', assignee: 'Mom' },
  ];
  return baseItems;
};

export const generateFestivalPlan = async (
  festival: FestivalType,
  familySize: number,
  budget: number
): Promise<ChecklistItem[]> => {
  const apiKey = process.env.API_KEY;
  
  if (!apiKey) {
    console.warn("No API Key found, using fallback data.");
    return generateFallbackPlan(festival, budget);
  }

  try {
    const ai = new GoogleGenAI({ apiKey });
    
    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: `Generate a detailed festival preparation checklist for ${festival} for a family of ${familySize} with a budget of ${budget} Rupees. 
      The list should be specific to Indian traditions.
      Include 6-10 key items across categories: Rituals, Food, Decor, Gifts, Cleaning.
      Provide an estimated cost for each item.
      Include a specific eco-friendly tip for each task.
      Suggest a generic family member role (Mom, Dad, Kids, Grandparents) as 'assignee' for each task.`,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.ARRAY,
          items: {
            type: Type.OBJECT,
            properties: {
              category: { type: Type.STRING, enum: ['Rituals', 'Food', 'Decor', 'Gifts', 'Cleaning'] },
              task: { type: Type.STRING },
              estimatedCost: { type: Type.NUMBER },
              ecoTip: { type: Type.STRING },
              assignee: { type: Type.STRING }
            },
            required: ['category', 'task', 'estimatedCost', 'ecoTip', 'assignee']
          }
        }
      }
    });

    const data = JSON.parse(response.text || '[]');
    
    return data.map((item: any, index: number) => ({
      id: `gen-${index}-${Date.now()}`,
      ...item,
      isCompleted: false
    }));

  } catch (error) {
    console.error("Gemini API Error:", error);
    return generateFallbackPlan(festival, budget);
  }
};
